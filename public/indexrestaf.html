<!DOCTYPE html>
<!--
  ~ /* ------------------------------------------------------------------------------------
  ~  * Copyright (c) SAS Institute Inc.
  ~  *  Licensed under the Apache License, Version 2.0 (the "License");
  ~  * you may not use this file except in compliance with the License.
  ~  * You may obtain a copy of the License at
  ~  *
  ~  * http://www.apache.org/licenses/LICENSE-2.0
  ~  *
  ~  *  Unless required by applicable law or agreed to in writing, software
  ~  * distributed under the License is distributed on an "AS IS" BASIS,
  ~  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ ----------------------------------------------------------------------------------------*/
  ~
  -->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/@sassoftware/restaf@4.3.0/dist/restaf.js"></script>
    <script src="https://unpkg.com/@sassoftware/restaflib@4.3.0/dist/restaflib.js"></script>
   

    <script src="/viyaapp/appenv"></script>


    <style>
      .container {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        min-height: 800px;
      }
      .elabel {
        display: inline-block;

        clear: left;
        width: 250px;
        text-align: right;
      }
      .einput {
        display: inline-block;
      }
      .div1 {
        border: 1px solid black;
        background: lightskyblue;
      }
      .div2 {
        border: 1px solid black;
        background: lightskyblue;
        height: 200px;
      }
    </style>

    <script>
      debugger;

      /* default options: {casProxy: false, withCredentials: true}*/
      let store = restaf.initStore({ casProxy: false });
      let session = null;
      let servers = null;
      let services = null;
      let files = null;
      let reports = null;
      let compute = null;
	  let computeSession = null;

      function setup() {
        document.getElementById("status").innerHTML = "...initializing";

        initSession()
          .then((r) => {
            document.getElementById("status").innerHTML = "ready";
          })
          .catch((e) => {
            console.log(e);
          });
      }
      async function initSession() {
        /* setup restaf to connect to Viya server */
        let msg = await store.logon(LOGONPAYLOAD);
		computeSession = await restaflib.computeSetup(store, null, null);
        return "done";
      }
      function runit(type) {
        debugger;
        document.getElementById("status").innerHTML = "...running";
        let testcase;
        switch (type) {
          case "files": {
            testcase = SASfileService;
            break;
          }
          case "compute": {
            testcase = dsCompute;
            break;
          }
          case "cas": {
            testcase = runCas;
            break;
          }
		  case "compute2": {
			testcase = dsCompute2;
			break;
		  }
          default: {
            testcase = SASfileService;
            break;
          }
        }
        debugger;
        testcase(store)
          .then((r) => {
            debugger;
            document.getElementById("output").innerHTML = JSON.stringify(
              r,
              null,
              4
            );
          })
          .catch((err) => {
            debugger;
            document.getElementById("output").innerHTML = JSON.stringify(
              err,
              null,
              4
            );
          });
      }

      function setContext(contexts, name) {
        let t = name.toLowerCase();
        let index = contexts
          .itemsList()
          .findIndex((c) => c.toLowerCase().indexOf(t) >= 0);
        if (index === -1) {
          throw { Error: "Compute Context not found: " + contextName };
        }
        return contexts.itemsList(index);
      }

      async function runCas(store) {
        debugger;
        let { casManagement } = await store.addServices("casManagement");
        let servers = await store.apiCall(casManagement.links("servers"));

        let serverName = servers.itemsList(0);
        debugger;
        let session = await store.apiCall(
          servers.itemsCmd(serverName, "createSession")
        );
        debugger;
        let payload = {
          action: "builtins.echo",

          data: {
            code: "data casuser.data1; x=1;put x= ; run; ",
          },
        };

        let r = await store.runAction(session, payload);
        console.log(r.items().toJS());
        debugger;
        console.log("echo completed");

        r = await store.runAction(session, payload);
        // await store.apiCall(session.links('delete'));
        console.log(r.items().toJS());
        console.log("echo 2 completed");

        return r.items();
      }

      async function SASfileService(store) {
        let { files } = await store.addServices("files");
        console.log(JSON.stringify(files.links(), null, 4));
        let payload = {
          data: { x: 1, y: "This was saved earlier in the step" },
          headers: { "content-type": "application/json" },
        };
        let createCmd = files.links("create");
        let newFile = await store.apiCall(createCmd, payload);
        let content = await store.apiCall(newFile.links("content"));
        return content.items();
      }
      async function dsCompute(store) {
        let log = null;
        let { compute } = await store.addServices("compute");
        let contexts = await store.apiCall(compute.links("contexts"));
        // lookup the name of the first context and then use it to get the associated createSession restafLink
        let context = setContext(contexts, "SAS Job Execution");
        let createSession = contexts.itemsCmd(context, "createSession");
        let session = await store.apiCall(createSession);

        // Now run a simple data step in that session
        let payload = {
          data: {
            code: [`data _null_; do i = 1 to 100; x=1; end; run; `],
          },
        };

        // Now execute the data step and wait for completion
        let job = await store.apiCall(session.links("execute"), payload);
        let status = await store.jobState(job, null, 5, 2);

        if (status.data === "running") {
          throw `ERROR: Job did not complete in allotted time`;
        } else {
          switch (status.data) {
            case "warning":
              console.log(`Warning: check your log for warnings`);
              break;
            case "error":
              throw `Please correct errors and rerun program`;
            default:
              log = await store.apiCall(status.job.links("log"));
              break;
          }
        }
        return log === null ? status : log.items();
      }
	  async function dsCompute2(store){
		debugger;
		
		console.log(computeSession);
		let macros = {
			x1: document.getElementById('x1').value,
			x2: document.getElementById('x2').value
		}
		let src = `
			ods html style=barrettsblue; 
			data work.dtemp1;
			total = &x1 + &x2;
			run;
			proc print;run;  
			ods html close;
			run;
				`;
		let computeSummary = await restaflib.computeRun(
			store,
			computeSession,
			src,	
			macros,
			15,2
    );
	
	// print log to console
	let log = await restaflib.computeResults(store, computeSummary, 'log');
	document.getElementById("log").innerHTML = JSON.stringify(
              log,
              null,
              4
            );
	let ods = await restaflib.computeResults(store, computeSummary, 'ods');
	document.getElementById("ods").innerHTML = ods;
	
	

	data = await restaflib.computeFetchData(
			store,
			computeSummary,
			'DTEMP1',
			'next',
			{offset: 0, limit:1}
		);

	document.getElementById("table").innerHTML = JSON.stringify(
              data,
              null,
              4
            );
			console.log(data.rows);
			console.log(data.rows[0][0]);
	document.getElementById("total").value = data.rows[0][0].toString();
	debugger;
	return data;

	}
    </script>
  </head>
  <body onload="setup()">
    <h1 id="head">Hi</h1>
    <h2>Using restaf to make REST API calls to Viya</h2>
    <div>
      <button onclick="runit('files')">
        Press to make a call to file service
      </button>
      <br />
      <br />
      <button onclick="runit('compute')">
        Press to make a call compute service
      </button>
      <br />
      <br />
      <button onclick="runit('cas')">Press to make a call to cas echo</button>
      <br />
      <br />
      <details>
        <summary>Run compute server with arguments</summary>

        <div>
          <form action="">
            <label class="elabel"> x1: </label>
			<input class="einput" type="input" id="x1" size="50" />
			<br/>
			<br/>
			<label class="elabel"> x2: </label>
			<input <class="einput" type="input" id="x2" size="50" />
			<br/>
			<br/>
			<label class="elabel"> Computed Total: </label>
			<input <class="einput" type="input" id="total" size="50" />
          </form>
          <br />
          <br />
          <button onclick="runit('compute2')">Run with arguments</button>
          <br />
        </div>
        <br />
        <br />
		<div>
			<h2>ODS output</h2>
			<pre id="ods"></pre>
		</div>
		<div>
			<h2>Table as JSON for further processing</h2>
			<pre id="table"></pre>
		</div>
		<div>
			<h2> Log output - see the macros prepended</h2>
			<pre id="log"></pre>
		</div>
       
      </details>

      <br />
    </div>

	<div>
		
	</div>
	<div>
		<pre id="status"></pre>
	</div>
	<div>
      <pre id="output"></pre>
    </div>
	  
  </body>
</html>
