<!DOCTYPE html>
<!--
  ~ /* ------------------------------------------------------------------------------------
  ~  * Copyright (c) SAS Institute Inc.
  ~  *  Licensed under the Apache License, Version 2.0 (the "License");
  ~  * you may not use this file except in compliance with the License.
  ~  * You may obtain a copy of the License at
  ~  *
  ~  * http://www.apache.org/licenses/LICENSE-2.0
  ~  *
  ~  *  Unless required by applicable law or agreed to in writing, software
  ~  * distributed under the License is distributed on an "AS IS" BASIS,
  ~  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ ----------------------------------------------------------------------------------------*/
  ~
  -->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/@sassoftware/restaf@4.4.8"></script>
    <script src="https://unpkg.com/@sassoftware/restaflib@4.4.8"></script>

    <script src="/viyaapp/appenv"></script>
    <script src="./lib/logViewer.js"></script>

    <style>
      .container {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        min-height: 800px;
      }
      .elabel {
        display: inline-block;

        clear: left;
        width: 250px;
        text-align: right;
      }
      .einput {
        display: inline-block;
      }
      .div1 {
        border: 1px solid black;
        background: lightskyblue;
      }
      .div2 {
        border: 1px solid black;
        background: lightskyblue;
        height: 200px;
      }
    </style>

    <script>
      debugger;
      let store = restaf.initStore();
      let computeSession = null; /* set computeSession as global */

      function setup() {
        document.getElementById("status").innerHTML = "...initializing - Creating compute session.";

        initSession()
          .then((r) => {
            document.getElementById("status").innerHTML = "ready for input";
          })
          .catch((e) => {
            console.log(e);
          });
      }

      async function initSession() {
        //  setup restaf to connect to Viya server 
        //  this logon supports password, token and authorization_code flow.
        //  here I am using authorizaton_code - the most common case for web apps
        //  if you are using VA's DDC then it is authorization code.
        // {host: <your Viya server url}, authType: 'code'}
        let msg = await store.logon(LOGONPAYLOAD);
        // setup compute session - this is a higher level object around compute session
        computeSession = await restaflib.computeSetup(store, null, null);
        return "done";
      }

      function runit(type) {
        debugger;
        document.getElementById("status").innerHTML = "...running your request";
        let testcase;

        easyCompute(store)
          .then((r) => {
            debugger;
            document.getElementById("status").innerHTML = "Run completed";
          })
          .catch((err) => {
            debugger;
            document.getElementById("status").innerHTML = JSON.stringify(
              err,
              null,
              4
            );
          });
      }

	  //
	  // Run compute service using user-friendly way 
	  //

      async function easyCompute(store) {

		//
		// These are prepended to src as macros
		//

        let macros = {
          x1: document.getElementById("x1").value,
          x2: document.getElementById("x2").value,
        };
		//
		// Sample code - replace with your own
		//
        let src = `
			ods html style=barrettsblue; 
			data work.dtemp1;
			total = &x1 + &x2;
			run;
			proc print;run;  
			ods html close;
			run;
				`;
		//
		// Run compute service and reduce results
		//
        let computeSummary = await restaflib.computeRun(
          store,
          computeSession,
          src,
          macros
        );

        // show log
        let log = await restaflib.computeResults(store, computeSummary, "log");
        document.getElementById("log").innerHTML = logViewer(log);

		// show ods
        let ods = await restaflib.computeResults(store, computeSummary, "ods");
        document.getElementById("ods").innerHTML = ods;

		// Fetch data
        data = await restaflib.computeFetchData(
          store,
          computeSummary,
          "DTEMP1",
          "next",
          { offset: 0, limit: 1 }
        );

		// Display data as json
        document.getElementById("table").innerHTML = JSON.stringify(
          data,
          null,
          4
        );

		// show total in the input field
        document.getElementById("total").value = data.rows[0][0].toString();
        debugger;
		// return data to caller.
        return 'done';
      }
  </script>
</head>
<body onload="setup()">
  <h2>Easy Button to access SAS/Viya compute server</h2>
     
      <div>
        <pre id="status"></pre>
      </div>
        <div>
          <form action="">
            <label class="elabel"> x1: </label>
            <input class="einput" type="input" id="x1" size="50" />
            <br />
            <br />
            <label class="elabel"> x2: </label>
            <input <class="einput" type="input" id="x2" size="50" />
            <br />
            <br />
            <label class="elabel"> Computed Total: </label>
            <input <class="einput" type="input" id="total" disabled size="50" />
          </form>
          <br />
          <br />
          <button onclick="runit()">Run request</button>
          <br />
        </div>
          <summary>
          <details>
             Your input is prepended to the sas program as macros.<br/>
             Note that the log line numbers will continue to increase<br/>
             with each run as one would expect in a single SAS session.
          </details>
        </summary>

        <br />
        <br />
        <div>
          <div>
            <h2>Table as JSON for further processing</h2>
            <pre id="table"></pre>
          </div>
          <div>
            <h2>ODS output</h2>
            <pre id="ods"></pre>
          </div>
        
          <div>
            <h2>Log output - see the macros prepended</h2>
            <pre id="log"></pre>
          </div>
    

      <br />
    </div>

  </body>
</html>
